---
title: "fable::TFEAM"
subtitle: "Tidy forecasting in R"
author: "Mitchell O'Hara-Wild"
date: '30/10/2018'
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: ["libs/slides.css",  "libs/animate.css"]
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: github
      ratio: '16:9'
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: ["libs/jquery/jquery.min.js", "libs/slides.js"]
---
class: inverse

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE, width = 120)

library(tidyverse)
library(knitr)
library(kableExtra)
library(fontawesome)
library(lubridate)
library(htmltools)

library(tsibble)
library(fasster)
library(fable)

opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center', 
  fig.width = 12, fig.height = 4, fig.show = 'hold',
  cache = TRUE, external = TRUE, dev = 'svglite', dev.args = list(bg = "transparent")
)

mp4_vid <- function(src){
  HTML(
    paste0(
      '<video autoplay>
        <source src="', src, '" type="video/mp4">
      </video>'
    )
  )
}

hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
   lines <- options$output.lines
   if (is.null(lines)) {
     return(hook_output(x, options))  # pass to default hook
   }
   x <- unlist(strsplit(x, "\n"))
   more <- "..."
   if (length(lines)==1) {        # first n lines
     if (length(x) > lines) {
       # truncate the output, but add ....
       x <- c(head(x, lines), more)
     }
   } else {
     x <- c(more, x[lines], more)
   }
   # paste these lines together
   x <- paste(c(x, ""), collapse = "\n")
   hook_output(x, options)
 })

theme_set(
  theme_grey(base_size = 16) + 
  theme(
    legend.position = "bottom",
    plot.background = element_rect(fill = "transparent"),
    legend.background = element_rect(fill = "transparent")
  )
)
```

.title[fable]
.sticker-float[![fable](resources/fable.svg)]

## Tidy forecasting in R

.bottom[
### Mitchell O'Hara-Wild (`r fa("twitter", fill="#1da1f2")`[@mitchoharawild](https://twitter.com/mitchoharawild))
### Rob Hyndman (`r fa("twitter", fill="#1da1f2")`[@robjhyndman](https://twitter.com/robjhyndman/))
### 8 November 2018
### Slides @ [???](#)
]

---
class: center

.animated.fadeIn[
## Time-series data is changing

<hr>
]

---
class: center

## Time-series data is changing

<hr>

.animated.fadeIn[
.pull-left[
### Multiple seasonality
### Irregular time intervals
### Frequent observations
]
.pull-right[
### Many variables and series
### Missing values
### Additional noise
]

<hr>

]


---
class: center

## Time-series data is changing

<hr>

.pull-left[
### Multiple seasonality
### Irregular time intervals
### Frequent obsrevations
]
.pull-right[
### Many variables and series
### Missing values
### Additional noise
]

<hr>

.animated.fadeIn[
## New tools are needed
.sticker[![tsibble](resources/tsibble.svg)]
.sticker[![fable](resources/fable.svg)]
.sticker[![fasster](resources/fasster.png)]
]

---

class: inverse, top

.sticker-float[![tsibble](resources/tsibble.svg)]

.title[tsibble]

* A modern temporal data structure
* Provides tools for time-related analysis
* Integrates seamlessly with the tidyverse

<br>

More information:

* `r fa("github", fill = "white")` [tidyverts/tsibble](https://github.com/tidyverts/tsibble)
* `r fa("globe", fill = "white")` [tsibble site](https://pkg.earo.me/tsibble/)
* `r fa("desktop", fill = "white")` [NY Meetup](http://slides.earo.me/bigapple/) & [useR!2018](http://slides.earo.me/useR18/)

---

## A simple example

```{r, echo=TRUE}
tsibbledata::ausretail
```

<!-- Features: -->

<!-- * Monthly observations -->
<!-- * One response variable -->
<!-- * 180 individual series (by State and Industry) -->

.footnote[Source: Australian Bureau of Statistics. Catalogue No. 8501.0]

---

## Victorian cafe and restaurant turnover

```{r, echo=TRUE}
vic_cafe <- tsibbledata::ausretail %>% 
  filter(State == "Victoria", Industry == "Cafes, restaurants and takeaway food services")
```
```{r cafe-plot}
vic_cafe %>% 
  autoplot(Turnover) + 
  ggtitle("Victorian cafe, restaurant and takeaway turnover") + 
  ylab("Turnover ($Million AUD)")
```

---

class: inverse, top

.sticker-float[![fable](resources/fable.svg)]

.title[fable]

* A tidy reimplementation of `forecast`
* Encourages flexible and transparent model design
* Many more features (the content of this talk!)

<br>

More information:

* `r fa("github", fill = "white")` [tidyverts/fable](https://github.com/tidyverts/fable)
* `r fa("desktop", fill = "white")` [TFEAM](#) & [useR!2018](https://github.com/robjhyndman/fable-talk-2018/raw/master/fable_useR2018.pdf)

---

## Model specification - with formulas

Using a formula is a concise method of model specification, and is used in most modelling functions in R. Use of a formula is rare in time series modelling, leading to complicated documentation and verbose interfaces.

```{r, echo = TRUE, eval = FALSE}
t(y) ~ trend() + fourier(K = 6) + x
```

--

.pull-left[

### LHS: Response
* Defines the data's response variable
* Specification of transformations
  (with automatic back-transformation)
]

--

.pull-right[

### RHS: Specials
* Model specific special functions
* Exogenous regressors
]

---

## Exponential smoothing

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-fit, echo = TRUE}
fbl_fit <- vic_cafe %>% 
  fable::ETS(Turnover ~ season("M"))
```
```{r ets-fit-print}
fbl_fit
```


]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-fit, echo = TRUE}
fc_fit <- ts(vic_cafe$Turnover, start = c(1982, 4), frequency = 12) %>% 
  forecast::ets("ZZM")
```
```{r ets-fc-fit-print, output.lines = 1:10}
fc_fit
```


]
]

---

## Modelling with transformations

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-fit-log, echo = TRUE}
vic_cafe %>% 
  fable::ETS(log(Turnover) ~ season("A"))
```

]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-fit-log, echo = TRUE, output.lines = 1:10}
ts(vic_cafe$Turnover, start = c(1982, 4), frequency = 12) %>% 
  forecast::ets("ZZA", lambda = 0)
```
]
]

---

## Modelling with exogenous regressors

```{r elecdemand}
tsibbledata::elecdemand
```



---

# Electricity demand (Monthly)
```{r elecMonthly}
mp4_vid("resources/anim1.mp4")
```

---

# Electricity demand (Daily)
```{r elecDaily}
mp4_vid("resources/anim2.mp4")
```

---

# Electricity demand (Half-hourly)
```{r elecPlot}
mp4_vid("resources/anim3.mp4")
```
---

# Electricity demand (Half-hourly)
```{r elecPlotZoom}
mp4_vid("resources/anim4.mp4")
```
---

## Modelling with exogenous regressors

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r arima-fit, echo = TRUE}
tsibbledata::elecdemand %>% 
  fable::ARIMA(
    Demand ~ pdq(1,1,0) + PDQ(2,0,2) + WorkDay + Temperature + I(Temperature^2))
```

]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r arima-fc-fit, echo = TRUE, eval = FALSE, output.lines = 1:10}
Arima(fpp2::elecdemand[,"Demand"])
```
]
]

---

## Producing forecasts

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-fc-log, echo = TRUE, output.lines = 1:8}
fbl_fit %>% forecast(h=12)
```
]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-fc-log, echo = TRUE, output.lines = 1:8}
fc_fit %>% forecast(h=12)
```
]
]

---

## Evaluating accuracy

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-accuracy-log, echo = TRUE}
fbl_fit %>% accuracy()
```
]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-accuracy-log, echo = TRUE}
fc_fit %>% forecast::accuracy()
```
]
]

---


class: inverse, top

.sticker-float[![fasster](resources/fasster.png)]

.title[fasster]

* A model for switching temporal patterns
* Supports exogenous regressors and handles missing values
* Flexible model specification

<br>

More information:

* `r fa("github", fill = "white")` [tidyverts/fasster](https://github.com/tidyverts/fasster)
* `r fa("desktop", fill = "white")` [useR!2018](https://mitchelloharawild.com/user2018/)

---

class: inverse, top

.sticker-float[![fable](resources/fable.svg)]

.title[Thanks! `r fa("comments", fill = "white")`]

<br>

.larger[
`r fa("github", fill = "white")` Learn more on GitHub: [tidyverts/fable](https://github.com/tidyverts/fable)

`r fa("chart-line", fill = "white")` Keep updated: [tidyverts.org](http://www.tidyverts.org)

`r fa("desktop", fill = "white")` Review slides: [???](#)

<br>

This work is licensed as `r fa("creative-commons", fill="white")` BY-NC 4.0.
]
