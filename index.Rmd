---
title: "fable::TFEAM"
subtitle: "Tidy forecasting in R"
author: "Mitchell O'Hara-Wild"
date: '30/10/2018'
output:
  xaringan::moon_reader:
    chakra: libs/remark-latest.min.js
    css: ["libs/slides.css",  "libs/animate.css"]
    lib_dir: libs
    seal: false
    nature:
      highlightStyle: github
      ratio: '16:9'
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: ["libs/jquery/jquery.min.js", "libs/slides.js"]
---
class: inverse

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE, width = 120)

library(tidyverse)
library(knitr)
library(kableExtra)
library(fontawesome)
library(lubridate)
library(htmltools)

library(tsibble)
library(fasster)
library(fable)

opts_chunk$set(
  echo = FALSE, warning = FALSE, message = FALSE, comment = "#>",
  fig.path = 'figure/', cache.path = 'cache/', fig.align = 'center', 
  fig.width = 12, fig.height = 4, fig.show = 'hold',
  cache = TRUE, external = TRUE, dev = 'svglite', dev.args = list(bg = "transparent")
)

mp4_vid <- function(src){
  HTML(
    paste0(
      '<video autoplay>
        <source src="', src, '" type="video/mp4">
      </video>'
    )
  )
}

hook_output <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
   lines <- options$output.lines
   if (is.null(lines)) {
     return(hook_output(x, options))  # pass to default hook
   }
   x <- unlist(strsplit(x, "\n"))
   more <- "..."
   if (length(lines)==1) {        # first n lines
     if (length(x) > lines) {
       # truncate the output, but add ....
       x <- c(head(x, lines), more)
     }
   } else {
     x <- c(more, x[lines], more)
   }
   # paste these lines together
   x <- paste(c(x, ""), collapse = "\n")
   hook_output(x, options)
 })

theme_set(
  theme_grey(base_size = 16) + 
  theme(
    legend.position = "bottom",
    plot.background = element_rect(fill = "transparent"),
    legend.background = element_rect(fill = "transparent")
  )
)
```

.title[fable]
.sticker-float[![fable](resources/fable.svg)]

## Tidy forecasting in R

.bottom[
### Mitchell O'Hara-Wild (`r fa("twitter", fill="#1da1f2")`[@mitchoharawild](https://twitter.com/mitchoharawild))
### Rob Hyndman (`r fa("twitter", fill="#1da1f2")`[@robjhyndman](https://twitter.com/robjhyndman/))
### 8 November 2018
### Slides @ [???](#)
]

---
class: center

.animated.fadeIn[
## Time-series data is changing

<hr>
]

---
class: center

## Time-series data is changing

<hr>

.animated.fadeIn[
.pull-left[
### Multiple seasonality
### Irregular time intervals
### Frequent observations
]
.pull-right[
### Many variables and series
### Missing values
### Additional noise
]

<hr>

]


---
class: center

## Time-series data is changing

<hr>

.pull-left[
### Multiple seasonality
### Irregular time intervals
### Frequent obsrevations
]
.pull-right[
### Many variables and series
### Missing values
### Additional noise
]

<hr>

.animated.fadeIn[
## New tools are needed
.sticker[![tsibble](resources/tsibble.svg)]
.sticker[![fable](resources/fable.svg)]
.sticker[![fasster](resources/fasster.png)]
]

---

class: inverse, top

.sticker-float[![tsibble](resources/tsibble.svg)]

.title[tsibble]

* A modern temporal data structure
* Provides tools for time-related analysis
* Integrates seamlessly with the tidyverse

<br>

More information:

* `r fa("github", fill = "white")` [tidyverts/tsibble](https://github.com/tidyverts/tsibble)
* `r fa("globe", fill = "white")` [tsibble site](https://pkg.earo.me/tsibble/)
* `r fa("desktop", fill = "white")` [NY Meetup](http://slides.earo.me/bigapple/) & [useR!2018](http://slides.earo.me/useR18/)

---

## A simple example

```{r, echo=TRUE}
tsibbledata::ausretail
```

<!-- Features: -->

<!-- * Monthly observations -->
<!-- * One response variable -->
<!-- * 180 individual series (by State and Industry) -->

.footnote[Source: Australian Bureau of Statistics. Catalogue No. 8501.0]

---

## Victorian cafe and restaurant turnover

```{r, echo=TRUE}
vic_cafe <- tsibbledata::ausretail %>% 
  filter(State == "Victoria", Industry == "Cafes, restaurants and takeaway food services")
```
```{r cafe-plot}
vic_cafe %>% 
  autoplot(Turnover) + 
  ggtitle("Victorian cafe, restaurant and takeaway turnover") + 
  ylab("Turnover ($Million AUD)")
```

---

## A more common/realistic example

```{r elecdemand, echo = TRUE}
tsibbledata::elecdemand
```

.footnote[Source: Australian Energy Market Operator, and the Australian Bureau of Meteorology]

---

### Electricity demand (Monthly)
```{r elecMonthly}
mp4_vid("resources/anim1.mp4")
```

---

### Electricity demand (Daily)
```{r elecDaily}
mp4_vid("resources/anim2.mp4")
```

---

### Electricity demand (Half-hourly)
```{r elecPlot}
mp4_vid("resources/anim3.mp4")
```
---

### Electricity demand (Half-hourly)
```{r elecPlotZoom}
mp4_vid("resources/anim4.mp4")
```

---

class: inverse, top

.sticker-float[![fable](resources/fable.svg)]

.title[fable]

* A tidy reimplementation of `forecast`
* Encourages flexible and transparent model design
* Many more features (the content of this talk!)

<br>

More information:

* `r fa("github", fill = "white")` [tidyverts/fable](https://github.com/tidyverts/fable)
* `r fa("desktop", fill = "white")` [TFEAM](#) & [useR!2018](https://github.com/robjhyndman/fable-talk-2018/raw/master/fable_useR2018.pdf)

---
class: inverse

.sticker-float[![fable](resources/fable.svg)]

.title[Model]

## Model specification and estimation

`ETS(tsibble, formula, ...)`

`ARIMA(tsibble, formula, ...)`

`TSLM(tsibble, formula, ...)`

and many more...

---

## Model specification - with formulas

Using a formula is a concise method of model specification, and is used in most modelling functions in R. Use of a formula is rare in time series modelling, leading to complicated documentation and verbose interfaces.

```{r, echo = TRUE, eval = FALSE}
transformation(y) ~ trend() + season(period = "day") + x
```

--

.pull-left[

### LHS: Response
* Defines the data's response variable
* Specification of transformations
  (with automatic back-transformation)
]

--

.pull-right[

### RHS: Specials
* Model specific special functions
* Exogenous regressors
]

---

## A basic model

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-fit, echo = TRUE}
fbl_fit <- vic_cafe %>% 
  fable::ETS(Turnover ~ season("M"))
```
```{r ets-fit-print}
fbl_fit
```


]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-fit, echo = TRUE}
fc_fit <- ts(vic_cafe$Turnover, start = c(1982, 4), frequency = 12) %>% 
  forecast::ets("ZZM")
```
```{r ets-fc-fit-print, output.lines = 1:10}
fc_fit
```


]
]

---

## Modelling with transformations

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-fit-log, echo = TRUE}
vic_cafe %>% 
  fable::ETS(log(Turnover) ~ season("A"))
```

]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-fit-log, echo = TRUE, output.lines = 1:10}
ts(vic_cafe$Turnover, start = c(1982, 4), frequency = 12) %>% 
  forecast::ets("ZZA", lambda = 0)
```
]
]

---

## Using exogenous information

```{r elecdemand-xreg, fig.height=5}
tsibbledata::elecdemand %>%
  gather("Series", "Value", Demand, Temperature) %>%
  mutate(Series = recode(Series, "Demand" = "Demand (GW)", "Temperature" = "Temperature (C)")) %>% 
  ggplot(aes(x=index, y=Value, group=Series)) +
  geom_line() +
  facet_grid(Series ~ ., scales = "free_y") + 
  xlab("Date") +
  ylab(NULL) +
  ggtitle("Electricity demanded and temperature") + 
  geom_smooth()
```

---

## Modelling with exogenous regressors

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r arima-fit, echo = TRUE, eval = FALSE}
tsibbledata::elecdemand %>% 
  fable::ARIMA(Demand ~ pdq(1,1,0) + PDQ(2,0,2, period = "day") +
      WorkDay + Temperature + I(Temperature^2))
```

]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r arima-fc-fit, echo = TRUE, eval = FALSE}
ts(fpp2::elecdemand[,"Demand"], frequency = 48) %>% 
  forecast::Arima(order = c(1,1,0), seasonal = c(2,0,2),
  xreg = cbind(fpp2::elecdemand[,c("WorkDay", "Temperature")],
               fpp2::elecdemand[,"Temperature"]^2))
```
]
]

---
class: inverse

.sticker-float[![broom](resources/broom.png)]
.sticker-float[![fable](resources/fable.svg)]

.title[Extract]

## Extract model information using tidy functions

`augment(mable, ...)`

`tidy(mable, ...)`

`glance(mable, ...)`

`components(mable, ...)`

---

# Extract (broom::augment)

```{r ets-augment, echo = TRUE}
augment(fbl_fit)
```

---

# Extract (broom::tidy)

```{r ets-tidy, echo = TRUE}
tidy(fbl_fit)
```

---

# Extract (broom::glance)
```{r ets-glance, echo = TRUE}
glance(fbl_fit)
```

---

# Extract (fable::components)
```{r ets-components, echo = TRUE}
components(fbl_fit)
```

---

# Extract (fable::components)
```{r ets-components-plot, echo = TRUE}
components(fbl_fit) %>% 
  gather(component, value, level, slope, season) %>% 
  ggplot(aes(x = Month, y = value)) + 
  geom_line() + 
  facet_grid(vars(component), scales = "free_y")
```

---
class: inverse

.sticker-float[![fable](resources/fable.svg)]

.title[Forecast]

## Forecast future values

`forecast(mable, new_data, h, ...)`

---

## Producing forecasts

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-fc-log, echo = TRUE}
fbl_fc <- fbl_fit %>% forecast(h=24)
```
```{r ets-fc-log-print, output.lines = 1:8}
fbl_fc
```
]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-fc-log, echo = TRUE}
fc_fc <- fc_fit %>% forecast(h=24)
```
```{r ets-fc-fc-log-print, output.lines = 1:8}
fc_fc
```
]
]

---

## Producing forecasts

```{r ets-fc-log-plot, echo = TRUE}
fbl_fc %>% autoplot(vic_cafe)
```

---
class: inverse

.sticker-float[![fable](resources/fable.svg)]

.title[Accuracy]

## Accuracy evaluation to compare models

`accuracy(mable, measures, ...)`

`accuracy(fable, new_data, measures, ...)`

---

## Evaluating accuracy

.flex-row[
.sticker-left[![fable](resources/fable.svg)]
.flex-col[
```{r ets-accuracy-log, echo = TRUE}
fbl_fit %>% accuracy()
```
]
]

--

<hr>

.flex-row[
.sticker-left[![forecast](resources/forecast.svg)]
.flex-col[
```{r ets-fc-accuracy-log, echo = TRUE}
fc_fit %>% forecast::accuracy()
```
]
]

---
class: inverse

.sticker-float[![fable](resources/fable.svg)]

# Forecasting with tables

```{r recap-simple-fit, echo = TRUE}
fbl_fit
```

--

```{r recap-ausretail, echo = TRUE}
tsibbledata::ausretail
```

---

# Estimate

```{r batch-ets, echo = TRUE}
all_ets <- tsibbledata::ausretail %>% 
  ETS(Turnover)
```
```{r batch-ets-print}
all_ets
```

---

# Extract (broom::augment)

```{r batch-augment, echo = TRUE}
augment(all_ets)
```

---

# Extract (broom::tidy)

```{r batch-tidy, echo = TRUE}
tidy(all_ets)
```

---

# Extract (broom::glance)
```{r batch-glance, echo = TRUE}
glance(all_ets)
```

---

# Extract (fable::components)
```{r batch-components, echo = TRUE}
components(all_ets)
```

---

# Extract (fable::components)

```{r batch-components-plot, echo = TRUE}
components(all_ets) %>% 
  filter(Industry == "Cafes, restaurants and takeaway food services") %>% 
  ggplot(aes(x = Month, y = level, colour = State)) + 
  geom_line()
```


---

# Forecast

```{r batch-fc, echo = TRUE}
all_fc <- all_ets %>% 
  forecast(h=24)
```
```{r batch-fc-print}
all_fc
```

---

```{r batch-fc-plot, fig.height=7}
tsibbledata::ausretail %>%
  filter(year(Month) >= 2000) %>% 
  ggplot(aes(x=Month, y=Turnover, colour = State)) + 
  geom_line() + 
  facet_wrap(~ Industry, scales = "free_y") + 
  geom_forecast(aes(ymin = lower, ymax = upper, level = level), 
                fortify(all_fc) %>% filter(year(Month) >= 2000), stat = "identity") +
  ylab("Turnover ($Million AUD)")
```

---

```{r batch-fc-cafe-plot, fig.height=7}
tsibbledata::ausretail %>%
  filter(Industry == "Cafes, restaurants and takeaway food services") %>% 
  ggplot(aes(x=Month, y=Turnover, colour = State)) + 
  geom_line() + 
  facet_wrap(~ Industry, scales = "free_y") + 
  geom_forecast(aes(ymin = lower, ymax = upper, level = level), 
                fortify(all_fc) %>% filter(Industry == "Cafes, restaurants and takeaway food services"), stat = "identity") +
  ylab("Turnover ($Million AUD)")
```

---

# Evaluate

```{r batch-accuracy, echo = TRUE}
all_ets %>% accuracy()
```

---
class: inverse

.sticker-float[![fable](resources/fable.svg)]

.title[Extending fable]

## Extending fable to support new models is easy!

---
class: inverse, top

.sticker-float[![fasster](resources/fasster.png)]

.title[fasster]

* A model for switching temporal patterns
* Supports exogenous regressors and handles missing values
* Flexible model specification

<br>

More information:

* `r fa("github", fill = "white")` [tidyverts/fasster](https://github.com/tidyverts/fasster)
* `r fa("desktop", fill = "white")` [useR!2018](https://mitchelloharawild.com/user2018/)

---

## Switching seasonality

```{r fasster-noswitching, fig.height = 5.3}
tsibbledata::elecdemand %>% 
  filter(month(index) == 6) %>%
  ggplot(aes(x=index, y = Demand)) +
  geom_line() + 
  xlab("Time") + 
  ylab("Electricity Demanded (GW)")
```

---

## Switching seasonality

```{r fasster-switching, fig.height = 6}
tsibbledata::elecdemand %>% 
  filter(month(index) == 6) %>%
  mutate(
    `Working Day` = ifelse(WorkDay == 1, Demand, NA),
    `Non-working Day` = ifelse(WorkDay == 0, Demand, NA)
  ) %>%
  gather("Day Type", "Demand", `Working Day`, `Non-working Day`) %>%
  ggplot(aes(x=index, y = Demand, colour = `Day Type`)) +
  geom_line() + 
  xlab("Time") + 
  ylab("Electricity Demanded (GW)") + 
  scale_colour_brewer(palette = "Dark2")
```

---

# Forecasting with fasster

```{r, fasster-elecfit, echo = TRUE}
fasster_fit <- tsibbledata::elecdemand %>%
  filter(index < ymd("2014-03-01")) %>%
  fasster(log(Demand) ~ WorkDay %S% (trig(48, 16) + poly(1)) + Temperature + I(Temperature^2))
```

```{r fasster-elecfit-print}
fasster_fit
```

```{r fasster-elecfc, echo = TRUE}
fasster_fc <- fasster_fit %>% 
  forecast(tsibbledata::elecdemand %>% filter(year(index) == 2014, month(index) == 3))
```

```{r fasster-elecfc-print}
fasster_fc
```

---

# Forecasting with fasster
```{r fasster-elecfc-plot, echo = TRUE}
fasster_fc %>% 
  autoplot(tsibbledata::elecdemand %>% filter(index < ymd("2014-03-01")))
```


---

class: inverse, top

.sticker-float[![fable](resources/fable.svg)]

# Additional features

## simulate()
## interpolate()

---

## Simulating future paths (`simulate()`)

```{r vic-cafe-sim, echo = TRUE}
vic_cafe_sim <- fbl_fit %>% 
  simulate(h = 24, times = 5)
```
```{r vic-cafe-sim-print}
vic_cafe_sim
```

---

## Simulating future paths (`simulate()`)

```{r vic-cafe-sim-plot, echo = TRUE}
vic_cafe %>% 
  filter(year(Month) >= 2010) %>% 
  autoplot(Turnover) + 
  geom_line(aes(y = .sim, group = .rep), alpha = 0.3, data = vic_cafe_sim)
```


---

## Interpolating missing values (`interpolate()`)

```{r olympic-running, echo = TRUE}
tsibbledata::olympic_running
```

.footnote[Source: The International Olympic Committee ([www.olympic.org](www.olympic.org))]

---

## Interpolating missing values (`interpolate()`)

```{r olympic-running-miss}
tsibbledata::olympic_running %>%
  ggplot(aes(x=Year, y = Time, colour = Sex)) +
  geom_line() +
  geom_point(size = 1) +
  facet_wrap(~ Length, scales = "free_y", nrow = 2) + 
  theme_minimal() + 
  scale_color_brewer(palette = "Dark2") + 
  theme(legend.position = "bottom", legend.title = element_blank()) +
  ylab("Running time (seconds)")
```

---

## Interpolating missing values (`interpolate()`)

```{r olympic-interpolated, echo = TRUE}
olympic_complete <- tsibbledata::olympic_running %>% 
  TSLM(Time ~ trend()) %>% 
  interpolate(tsibbledata::olympic_running)
```

```{r olympic-running-completed}
tsibbledata::olympic_running %>%
  ggplot(aes(x=Year, y = Time, colour = Sex)) +
  geom_line(aes(linetype = "Interpolated"), data = olympic_complete) +
  geom_line(aes(linetype = "Actual")) +
  geom_point(size = 1) +
  facet_wrap(~ Length, scales = "free_y", nrow = 2) + 
  theme_minimal() + 
  scale_color_brewer(palette = "Dark2") + 
  theme(legend.position = "bottom", legend.title = element_blank()) +
  ylab("Running time (seconds)")
```

---

class: inverse, top

.sticker-float[![fable](resources/fable.svg)]

.title[Thanks! `r fa("comments", fill = "white")`]

<br>

.larger[
`r fa("github", fill = "white")` Learn more on GitHub: [tidyverts/fable](https://github.com/tidyverts/fable)

`r fa("chart-line", fill = "white")` Keep updated: [tidyverts.org](http://www.tidyverts.org)

`r fa("desktop", fill = "white")` Review slides: [???](#)

<br>

This work is licensed as `r fa("creative-commons", fill="white")` BY-NC 4.0.
]
